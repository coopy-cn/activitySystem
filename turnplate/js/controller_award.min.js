if(!Object.keys){Object.keys=function(c){if(c!==Object(c)){throw new TypeError("Object.keys called on a non-object")}var a=[],b;for(b in c){if(Object.prototype.hasOwnProperty.call(c,b)){a.push(b)}}return a}}(function(app){if(game.$$isAwardWithPot){var checkedPotTotal=function(argument){var potTotal=0;for(var i=0;i<game._setting.an;i++){potTotal+=awardList[i].pot}if(potTotal>100){ERR.addErr($(".awardPot"),"总中奖率不超过100%",$("#awardDetail"),"margin-left:"+g_awardMg+"px;");return"$old"}ERR.removeErr($(".awardPot"))}}app.controller("awardListCtrl",["$rootScope","$scope","watch","HdGameDef","$sce","$timeout",function($root,$scope,watch,HdGameDef,$sce,$timeout){watch=watch.$new($scope);awardList.$$initTime=new Date();$scope.checkCuscode=checkCuscode;$scope.awardName=game.$$isQmKj||game.$$isPtzf?"商品":"奖项";$scope.awardNumName=game.style==71?"中奖团":$scope.awardName;$scope.setAwardNum=function(increase){var newAn=game._setting.an+increase;if(newAn<1||newAn>8){return}game._setting.an=newAn};game.$checkeIndex=0;watch("game.$checkeIndex",function(index,lastIndex){var award=game.$cAward=game._awardList[index];$$(function(){if(game._awardList[index].awardtype==9){$$("#awardDetailBox #forJZCouponBg").show()}else{$$("#awardDetailBox #forJZCouponBg").hide()}getPreviewWin().hg.fire("awardCheckIndexChange",index,lastIndex)});var awardSetting=$(".awardSettingBox").eq(index);var awardDef=gameDef._awardList[index];if(index!=lastIndex){var awardLineL=$(".awardSettingBox").eq(lastIndex);var awardLineR=awardSetting;awardLineL.addClass("abs");awardLineR.addClass("abs");awardLineL.animate({left:(index>lastIndex?-500:500)},200);awardLineR.animate({left:0},200);$("#awardDetail").css("overflow","hidden");setTimeout(function(){awardLineL.hide();awardLineR.show();awardLineL.removeClass("abs");awardLineR.removeClass("abs");$("#awardDetail").css("overflow","visible")},200)}$$.on("load",function(){var awardImgSrc=award.aimg||awardDef.aimg;var sucImg=$$("#resule-gift-sucImg");sucImg.attr("src",awardImgSrc).data("defData",{width:awardDef.aimgw,height:awardDef.aimgh});sucImg.add(sucImg.parent()).css({width:award.aimgw,height:award.aimgh});if(award.aimgw!=awardDef.aimgw||award.aimgh!=awardDef.aimgh){sucImg.attr("resize","1")}else{sucImg.attr("resize","0")}var theRealFlag=lastIndex>index;Math.abs(lastIndex-index)>(game._flag.f16?7:1)&&(theRealFlag=!theRealFlag);imgSlideAnimate(theRealFlag?-1:1,awardImgSrc,award);var targetLeft=($("#gameContent").width()-sucImg.parent().width())/2-$$(".hd-left-arrow").width();if(targetLeft<=0){targetLeft=($("#gameContent").width()-sucImg.parent().width())/2+5}});!g_isVersion3&&$scope.$$postDigest(function(){$("#awardBox .awardItemName.noBorder").removeClass("noBorder");var checked=$("#awardBox .awardLevelItem.checked");checked.add(checked.prev(".awardLevelItem")).find(".awardItemName").addClass("noBorder")});if(ERR.hasErr(awardSetting)){var awardCashSiteErr;var errs=ERR.getErr(awardSetting);$.each(errs,function(index,item){if($(item).hasClass("awardCashSite")){ERR.addErr($(item),"<span class='errSite'>"+award.$type.site+"</span>不能为空",$(".awardDetail"),"margin-left: 0px;");return false}})}});function imgSlideAnimate(theRealFlag,src,award){$$("#resule-gift-sucImg").css("opacity",0);var targetLeft1=theRealFlag*getPreviewWin().parseRemToPx(award.aimgh);var targetLeft2=theRealFlag*14+"rem";$$("#next-resule-gift-sucImg").attr("src",src).css({left:targetLeft1+"px",width:award.aimgw,height:award.aimgh});var theLeft=(getPreviewWin().g_rem*16-getPreviewWin().parseRemToPx(award.aimgw))/2;$$(".resule-gift-Jscontroler").css({left:theLeft});$$("#next-resule-gift-foot .next-fonts-foot").css("left",targetLeft2);$$("#next-resule-gift-rank .gifArg").text(award.style);$$("#next-resule-gift-goods .gifArg").text(award.name);setTimeout(function(){$$("#next-resule-gift-foot").css({height:$$("#resule-gift-foot").height()+"px"});$$("#resule-gift-foot").hide();$$("#resule-gift-foot.no1").addClass("no2");$$("#resule-gift-foot").addClass("no1")},0);$$("#resule-gift-foot.no2").hide();$$(".resule-gift-Jscontroler,#next-resule-gift-foot").show();$$("#next-resule-gift-sucImg,#next-resule-gift-foot .next-fonts-foot").addClass("imgSlidTransition");setTimeout(function(){$$("#next-resule-gift-sucImg,#next-resule-gift-foot .next-fonts-foot").css({left:0})},0);clearTimeout($$("#resule-gift-sucImg").data("imgSlideAnimateTimer"));$$("#resule-gift-sucImg").data("imgSlideAnimateTimer",setTimeout(function(){$$("#resule-gift-sucImg").css("opacity",1);$$("#resule-gift-foot").add($$("#resule-gift-sucImg").parent()).show();$$("#next-resule-gift-foot,.resule-gift-Jscontroler").hide();if(hdFai.isIE10){$$("#resule-gift-sucImg").parent().css({margin:"32px auto",})}$$("#next-resule-gift-sucImg,#next-resule-gift-foot .next-fonts-foot").removeClass("imgSlidTransition");var callBack=$$("#resule-gift-sucImg").data("imgSlideAnimateEnd");if(callBack){callBack.call($$("#resule-gift-sucImg")[0]);callBack=null;$$("#resule-gift-sucImg").removeData("imgSlideAnimateEnd")}},300))}var isClick=false;$$(function(){function Going(flag){$scope.$safeApply(function(){var maxIndex=game._setting.an+(game._flag.f16?0:-1);var checkeIndex=$(".awardLevelItem.checked").index();checkeIndex+=flag;if(checkeIndex<0){checkeIndex=maxIndex}else{if(checkeIndex>maxIndex){checkeIndex=0}}if(game._flag.f16&&checkeIndex==maxIndex){checkeIndex=8}game.$checkeIndex=checkeIndex;setTimeout(function(){clearTimeout($$("#resule-gift-sucImg").data("_sucImgTimer"));$$("#resule-gift-sucImg").parent().trigger("mouseover")},10);getPreviewWin().HdGame.removeAllEditLayer()})}$$("#resule-gift-scrollWrap").on("click",".theArrowSpan",function(e){isClick=true;var theDes=1;if($(this).hasClass("hd-left-arrow")){theDes=-1}Going(theDes);$$("#resule-gift-sucImg").trigger("hd-resizable-resize")})});$scope.$$postDigest(function(){$$.on("load",function(){$(".wxCardInput").one("change",function(){if(!hasWxCardInput){hasWxCardInput=true}});$(document).click(function(e){if(!$(e.target).is(".exitCuscodeTips *")&&!$(e.target).is(".cusCodeInputBox .underline")&&!$(e.target).is(".uploadCusCode .underline")){$(".exitCuscodeTips,.tipsArrow,.exitCuscodeCloseBtn").hide()}});function changeSucImg(index,data){operateFlagList[24]=true;var theIndexNoer=$$("#resule-gift-sucImg").data("theImgUploadIndex");theIndexNoer=theIndexNoer?theIndexNoer:0;var path=data;if(typeof data==="object"){path=data.path}awardList[theIndexNoer].aimg=path;if(theIndexNoer==game.$checkeIndex){$$("#resule-gift-sucImg").data("your-Original-Size",data).attr("src",path)}else{if(!data.path){return}$$("#resule-gift-sucImg").removeData("your-Original-Size");var defData=$.extend({},$$("#resule-gift-sucImg").data("defData"));defData.realWidth=getPreviewWin().parseRemToPx(defData.width);defData.realHeight=getPreviewWin().parseRemToPx(defData.height);var realSize=hdFai.Img.calcSize(data.width,data.height,defData.realWidth,defData.realHeight,hdFai.Img.MODE_SCALE_DEFLATE_FILL);var theWidth=getPreviewWin().parsePxToRem(realSize.width+"px");var theheight=getPreviewWin().parsePxToRem(realSize.height+"px");game._awardList[theIndexNoer].aimgw=theWidth;game._awardList[theIndexNoer].aimgh=theheight}getPreviewWin().hg.fire("changeAwardImg",theIndexNoer,path,data)}$$("#resule-gift-sucImg").addEditUploadFn("success",function(data,index){$$("#resule-gift-sucImg").data("theImgUploadIndex",index);index==game.$checkeIndex&&$$("#resule-gift-sucImg").data("your-Original-Size",data);changeSucImg(game.$checkeIndex,data)}).addEditUploadFn("recover",function(imgPath){changeSucImg(game.$checkeIndex,imgPath);var theIndexNoer=$$("#resule-gift-sucImg").data("theImgUploadIndex");$$(this).removeData("your-Original-Size");if(theIndexNoer==game.$checkeIndex){var def=$$(this).data("defData");$$(this).add($$(this).parent()).width(def.width).height(def.height)}}).addResizableFn("recover",function(event,def){$$(".hd-left-arrow,.hd-right-arrow").show();game.$cAward.aimgw=parsePxToRem($(this).css("width"));game.$cAward.aimgh=parsePxToRem($(this).css("height"))}).addResizableFn("stop",function(event,ui){var index=$(".awardLevelItem.checked").index();game.$cAward.aimgw=parsePxToRem($(this).css("width"));game.$cAward.aimgh=parsePxToRem($(this).css("height"));$(this).css("margin","0px");var screenWidth=$("#gameContent").width();var targetLeft=(screenWidth-ui.size.width)/2-$$(".hd-left-arrow").width();if(targetLeft<=0){targetLeft=(screenWidth-ui.size.width)/2+5}if((($(this).height()-$$(".hd-left-arrow").height())/2)<$(this).parent().find(".recoverBtn").height()){$(this).parent().find(".recoverBtn").css({bottom:"-20px",right:"0px"})}else{$(this).parent().find(".recoverBtn").css({bottom:"3px",right:"3px"})}$$(".hd-left-arrow,.hd-right-arrow").show();operateFlagList[24]=true}).addResizableFn("resize",function(){$$(".hd-left-arrow").hide();$$(".hd-right-arrow").hide()}).addResizableFn("start",function(){$$(".hd-left-arrow").hide();$$(".hd-right-arrow").hide()});if(game.style==48||game.style==67||game.style==77){$(".selectPicHY").each(function(index,element){element=$(element);Edit.createHtml5Upload({groupId:0,uploadImg:element.closest(".comUploadWarp").find(".comUploadImg img"),uploadBtn:element,from:-1,isPortal:true,buttonText:"＋ 选择图片",limit:5000,showProgress:true,progressBox:element,onSuccess:function(data){if(data.success){$$("#resule-gift-sucImg").data("theImgUploadIndex",index);changeSucImg(index,data)}else{console.warn("上传图片失败")}}})});$$("#resule-gift-sucImg").addEditUploadFn("recover",function(imgPath,obj,imgBoxId){changeSucImg(game.$checkeIndex,imgPath)})}(function(){var sucImg=$$("#resule-gift-sucImg"),arrow=$$(".hd-left-arrow,.hd-right-arrow");sucImg.parent().on("mouseover",function(){clearTimeout(sucImg.data("_sucImgTimer"));arrow.show()}).on("mouseleave",function(){sucImg.data("_sucImgTimer",setTimeout(function(){arrow.hide()},200))});arrow.on("mouseover",function(){$$("#resule-gift-sucImg").parent().trigger("mouseover")}).on("mouseleave",function(){if(isClick){isClick=false;return}$$("#resule-gift-sucImg").parent().trigger("mouseleave")})})()})});watch("game.$cAward",function(newValue){$scope.cAward=newValue});watch("cAward.$type.showsitebox",function(newValue,oldValue){$$(function(){$$("#awardDetailBox .codeOptInfo").data("moduleLayerDisable",!newValue)})});watch("cAward.$type.sitetype != 'url'",function(newValue,oldValue){$$(function(){$$("#awardDetailBox .bottomCusBtn").data("moduleLayerDisable",newValue).toggleClass("disableBtn",newValue)})});watch("cAward.t_type",function(newValue,oldValue){$$(function(){var isRange=newValue=="DATE_TYPE_FIX_TIME_RANGE";$$("#awardDetailBox .codeTimeFixedTerm").toggle(!isRange);$$("#awardDetailBox .codeTimeFixedRange").toggle(isRange)})});watch("cAward.cfbt",function(newValue,oldValue){$$(function(){$$("#awardDetailBox .codeTimeFixedTerm .codeBgTime").html(newValue||"当")})});watch("cAward.cft",function(newValue,oldValue){$$(function(){$$("#awardDetailBox .codeTimeFixedTerm .codeEndTime").html(newValue)})});watch("cAward.attention!=1",function(newValue,oldValue){$$(function(){$$("#awardDetailBox .awardCusBtn .textDef").toggle(!newValue);$$("#awardDetailBox .awardCusBtn .text").toggle(!!newValue)})});watch("cAward.optx",function(newValue,oldValue){$$(function(){$$("#awardDetailBox .awardCusText .textDef").toggle(!newValue);$$("#awardDetailBox .awardCusText .text").toggle(newValue)})});watch("cAward.style",function(newValue,oldValue){$$(function(){$$("#resule-gift-box .awardStyle").text(newValue)})})();watch("cAward.name",function(newValue,oldValue){$$(function(){$$("#resule-gift-box .awardName").text(newValue);$$("#awardDetailBox .awardName").text(newValue)})})();function changeAwardDetailWhenFixTerm(str1,str2){var codeTimeFixedTerm1=$$(".awardDetail .codeTimeFixedTerm");var codeTimeFixedTerm2=$$(".ticketInfo .codeTimeFixedTerm");if(codeTimeFixedTerm1.text().indexOf(str1)>=0){var replaceText=codeTimeFixedTerm1.html().replace(eval("/"+str1+"/g"),str2);codeTimeFixedTerm1.html(replaceText)}if(codeTimeFixedTerm2.text().indexOf(str1)>=0){var replaceText=codeTimeFixedTerm2.html().replace(eval("/"+str1+"/g"),str2);codeTimeFixedTerm2.html(replaceText)}}watch('cAward.awardtype == 4 && cAward.t_type == "DATE_TYPE_FIX_TERM"',function(newValue,oldValue){if(newValue){$$(function(){changeAwardDetailWhenFixTerm("中奖","领取")})}else{$$(function(){changeAwardDetailWhenFixTerm("领取","中奖")})}})();watch('game._awardList[0].needlessconsume&&game._awardList[0].$type.sitetype == "url"',function(newValue,oldValue){if(newValue==oldValue){return}$$.on("load",function(){$$(".awardWrap").toggle(!newValue);$$(".awardWrap").next("div").toggle(!newValue)})});$scope.getStoreAddress=function(store){if(store.province=="北京"||store.province=="天津"||store.province=="上海"||store.province=="重庆"){return store.city+store.county+store.address}return store.province+store.city+store.county+store.address};game.$saveComfort=game._flag.f16;$$.on("breakSave",function(flag){$scope.$safeApply(function(){if(flag=="right"&&!game.$saveComfort){game.$saveComfort=game._flag.f16}})});watch("game._flag.f16",function(newValue,oldValue){toggleLock($(".awardSettingBox.anweiBox"),newValue);if(!newValue){$("#sysAwardCode8").click()}$$(function(){var theImgList=getPreviewWin().hg.edit.cache["resule-gift-sucImg"];theImgList&&(theImgList[8].hide=!newValue);$$(".awardItem.anwei").toggle(newValue);getPreviewWin().hg.fire("changeAwardNum",-1,newValue)});if(newValue===oldValue){return}if(oldValue&&game.$checkeIndex==8){game.$checkeIndex=0}});!game._setting.an&&(game._setting.an=3);game.$saveMaxAn=game._setting.an;$$.on("breakSave",function(flag){$scope.$safeApply(function(){if(flag=="right"&&game._setting.an>game.$saveMaxAn){game.$saveMaxAn=game._setting.an}})});watch("game._setting.linkInfotype",function(newValue,oldValue){$$(function(){getPreviewWin().hg.fire("changeContactImg",newValue)})});watch("game._setting.an",function(newValue,oldValue){$$(function(){getPreviewWin().hg.fire("changeAwardNum",newValue);var theImgList=getPreviewWin().hg.edit.cache["resule-gift-sucImg"];if(theImgList){$.each(theImgList,function(index,value){if(index+1>newValue){if(index<8){getPreviewWin().hg.edit.cache["resule-gift-sucImg"][index].hide=true}}else{getPreviewWin().hg.edit.cache["resule-gift-sucImg"][index].hide=false}})}$$(".awardItem.unComfortLine").each(function(index,el){$(this).toggle(index<newValue)})});if(newValue===oldValue){return}operateFlagList[8]=true;if(oldValue>newValue){$scope.delCusCode(oldValue-1);awardList[oldValue-1].amount=game.$$prizedNum[oldValue-1]}game.$checkeIndex=newValue-1;if(game.$$isAwardWithPot){checkedPotTotal()}Edit.checkAmountTotal();Edit.checkPasswordredTotal()});$scope.$watchGroup(["game._setting.linkInfoAll","game._setting.linkInfotype"],function(newValue,oldValue){if(newValue==oldValue){return}if(newValue[1]==4){for(var index=0;index<9;index++){awardList[index].oplink=!newValue[0]}}else{if(newValue[1]==1){for(var index=0;index<9;index++){awardList[index].oplink=false}}}});$scope.delCusCode=function(count){var award=awardList[count];if(award.iscuscode){var uploadCusCode=$(".uploadCusCode").eq(count);cusCodelist=cusCodelist.filter(function(item,index){return item.level!=count+1});award.excelName="";uploadCusCode.find(".uploadBtn .uploadify-button").text("上传文件");var uploadTip=uploadCusCode.find(".uploadTip");uploadTip.text("每个券号不超过40个字符，券号数量与奖品数量需一致，发布后生成券号方式将无法更改");if(uploadTip.hasClass("inputErrMsg")){uploadTip.find("div").remove();uploadTip.removeClass("inputErrMsg");ERR.removeErr(uploadCusCode.find(".cusCodeFile"))}}};$scope.downloadCusCode=function(template,index){var codeList=[];var exportCusCodeForm=$(".exportCusCodeForm").eq(index);var url="/ajax/hdportal_h.jsp?cmd=exportCusCode&_TOKEN="+$("#_TOKEN").attr("value")+"&level="+(index+1)+"&filename="+awardList[index].excelName+"&version="+awardList[index].version;if(template){url+="&template=template"}else{if(!isPublish){$.each(cusCodelist,function(_index,item){if(item.level==(index+1)){codeList.push(item)}});exportCusCodeForm.find(".cusCodeStr").val(JSON.stringify(codeList))}if(game.id>0){url+="&gameId="+game.id}}exportCusCodeForm.attr("action",url);$(window).off("beforeunload");exportCusCodeForm.submit()};$scope.uploadCuscode=function(index){var award=awardList[index];var cusCodeBox=$("#awardDetail .cusCodeBox").eq(index);if(award.$$theCusAwardStatus!=2){checkCuscode(index,function(i,success){var cusVersList=[];if(success){var cusCodes=getCodeListByVal(award.$$thisLevelCuscode);if(game.$$isOpenNewCuscode){var tmpCode="";$.each(awardList,function(i,award){if(award.iscuscode&&i!=index&&i<game._setting.an){cusVersList.push({version:award.version,level:(i+1)});if(award.cuscodes&&cusCodes){for(var i=0;i<award.cuscodes.length;++i){if(cusCodes.contains(award.cuscodes[i])){tmpCode=award.cuscodes[i];break}}}}});if(tmpCode!=""){var tipsColor=$(".cusCodeInputBox .tipsColor").eq(index);tipsColor.addClass("inputErrMsg");tipsColor.html("含有重复自定义兑奖码:"+tmpCode);tipsColor.show();ERR.addErr(cusCodeBox);return}}top.HdPortal.wxCardProgress.init(true,100,200,"正在导入券号");$.ajax({url:"/ajax/advanceUpload.jsp?cmd=uploadCustomCode&gameid="+game.id+"&level="+award.level+"&amount="+award.amount,type:"post",data:{customs:JSON.stringify(cusCodes),versions:JSON.stringify(cusVersList),version:award.version},success:function(result){top.HdPortal.wxCardProgress.end();result=$.parseJSON(result);if(result.success){$scope.$safeApply(function(){award.version=result.msg;award.$$theCusAwardStatus=2});var theCusCodeBox=$("#awardDetail .cusCodeBox").eq(i).attr("disabled","disabled");$(this).removeClass("inputErr");$(".tipsArrow").hide();$(".cusCodeInputBox .tipsColor").eq(i).hide();ERR.removeErr(cusCodeBox)}else{var tip=$(".cusCodeInputBox .tipsColor").eq(index).show();tip.html(result.msg);tip.addClass("errMsg");ERR.addErr(cusCodeBox)}}})}})}else{cusCodeBox.removeAttr("disabled");award.$$theCusAwardStatus=3;ERR.removeErr($(this))}};$scope.passwordredFormat={formatter:function(args){return hp.Num.div(args.$modelValue,100)},parser:function(args){var val=args.$viewValue;var match=val.match(/\d+\.?\d{0,2}/);if(match&&match[0]!=val){val=match[0]}val=parseInt(hp.Num.mul(parseFloat(val),100));return isNaN(val)?undefined:val},};$scope.awardPriceFormat={parser:function(args){var val=args.$viewValue;var match=val.match(/\d{0,6}\.?\d?/);if(match&&match[0]!=val){val=match[0]}val=parseFloat(val);return isNaN(val)?undefined:val},};(function(){$scope.selectJZCoupon=function(award){if(award.jzCouponId&&award.$disabled){return}var poupUpBox=top.$("#poup_selectJZCouponBox");var defData={jzCouponId:award.jzCouponId};var crrData=defData;var siteList=game.$$siteInfoList.length==0?["siteId:-1"]:game.$$siteInfoList;if(poupUpBox.length>0){poupUpBox.remove()}poupUpBox=HdPortal.poupUpBox('<style>#poup_selectJZCouponBox .poupBottom .icon{display: none;}#poup_selectJZCouponBox .contentBox .center{max-height: 500px;overflow-y: auto;}#poup_selectJZCouponBox .contentBox tr td{text-align: center;}#poup_selectJZCouponBox .contentBox tr .select{width: 80px;height: 25px;border: 1px solid #CCCCCC;display: inline-block;cursor: pointer;line-height: 25px;}#poup_selectJZCouponBox .contentBox tr .select.selected{border-color: #74B5E5;}#poup_selectJZCouponBox .contentBox tr .select.disabled{background: #CCCCCC;cursor: auto;}#poup_selectJZCouponBox .contentBox tr th.timeColumn{width: 200px;}#poup_selectJZCouponBox .poupContent .site{margin: -8px 0 17px;color: #787878;}#poup_selectJZCouponBox .poupContent .selectSite{font-size: 17px !important;height: 45px;width: 375px;padding-left: 8px;margin-left: 15px;font-size: 14px;outline: 0;border: 1px solid #e7e7eb;}</style><div class="site">选择网站：<select class="selectSite"></select></div><div class="contentBox faiTableType2"></div>',2,"请选择奖品","width: 800px;",true,"selectJZCouponBox",function(){if(crrData!==defData){$scope.$safeApply(function(){updataJZ(crrData,award,poupUpBox)})}});$.ajax({url:HdPortal.versionURL+"/ajax/couponInterface_h.jsp?cmd=getSiteList",type:"post",success:function(data){var result=$.parseJSON(data);var content="";if(result.length>0){if(result.length==1){poupUpBox.find(".site").attr("siteId",result[0].siteId).hide()}else{for(var i=0;i<result.length;i++){content+='<option siteId="'+result[i].siteId+'">'+result[i].name+"</option>"}poupUpBox.find(".selectSite").html(content)}}else{if(result.length==0){poupUpBox.find(".site").attr("siteId","-1").hide()}}}});poupUpBox.find(".selectSite").on("change",function(){var elem=$(this);var jzSiteId=elem.find("option:selected").attr("siteId");poupUpBox.find(".contentBox").faiTable("searchString",{uid:0,cmd:"eq",searchKeyList:["siteId"],searchString:parseInt(jzSiteId),})});var contentBox=poupUpBox.find(".contentBox");contentBox.faiTable({tableColumn:{colClass:"",columns:[{key:"showIndex",name:"卡券ID",extData:function(back,data){return back+1}},{key:"couponName",name:"名称"},{key:"savePrice",name:"抵消金额"},{key:"conditions",name:"使用条件",extData:function(back,data){return"订单额满"+data.orderMinPrice}},{key:"validityTime",name:"有效时间",colClass:"timeColumn",extData:function(back,data){return data.validity.replace("-","至")}},{key:"operate",name:"操作",extData:function(back,data){if(data.id){if(crrData.jzCouponId===data.id){crrData=data;return'<div class="select selected">已选择</div>'}else{for(var i=0;i<game._setting.an;i++){var checkAward=awardList[i];if(award!==checkAward&&checkAward.awardtype==9&&checkAward.jzCouponId==data.id){return'<div class="select disabled">选择</div>'}}}}return'<div class="select">选择</div>'}}]},bottom:{show:true,showTotal:true,showAllTotal:true,showPage:true,showPageJump:true,showPageNumSelect:true,},ajaxPage:{url:HdPortal.versionURL+"/ajax/couponInterface_h.jsp?cmd=getCouponList",regroup:regroup,},tmp:{searchMatcher:[{uid:0,cmd:"eq",searchKeyList:["siteId"],searchString:siteList[0].siteId,}]},cache:false,noDataMsg:"您还没有商城优惠券，请先在网站后台添加",primaryKey:"id",page:{startPage:1,showCountList:[10,20,30],showCount:10},itemHover:true,});contentBox.on("click","tr .select",function(){var elem=$(this);if(!elem.hasClass("selected")&&!elem.hasClass("disabled")){var lastSelected=contentBox.find("tr .select.selected");if(lastSelected.length>0){lastSelected.removeClass("selected").text("选择")}crrData=contentBox.faiTable("getPrimaryKeyData",elem.closest("tr").attr("id"),true);elem.addClass("selected").text("已选择")}else{if(elem.hasClass("disabled")){HdPortal.hdShowMsg("error","你已在其他奖项中选择了该优惠券，不可重复选择同一张")}}});poupUpBox.on("poupBox_close",function(){contentBox.faiTable("abortAjaxPage")})};function regroup(rt){if(rt.success){rt.totalCount=rt.total;rt.dataList=rt.data?rt.data:[]}}function updataJZ(data,award,poupUpBox){if(!data||!award){return}var isOneSite=poupUpBox.find(".site").is(":hidden");var siteId=isOneSite?poupUpBox.find(".site").attr("siteId"):poupUpBox.find(".selectSite option:selected").attr("siteId");award.jzCouponId=data.id;award.name=data.couponName;!award.jzData&&(award.jzData={});award.jzData.jzCouponId=data.id;award.jzData.siteId=parseInt(siteId);if(data.hdCouponLeaveAmount){award.jzData.$TotalCount=data.hdCouponLeaveAmount}}})();(function(){if(!game.$$isYKY){return}var guids={};for(var i=0;i<game._setting.max_an;i++){var award=awardList[i];var guid=award.guid;if(guid){!guids[guid]&&(guids[guid]=[]);guids[guid].push(award)}}if(!$.isEmptyObject(guids)){$.ajax({url:HdPortal.versionURL+"/ajax/hdportal_h.jsp?cmd=getYKYCouponList&guidList="+$.toJSON(Object.keys(guids)),type:"post",success:function(data){var result=$.parseJSON(data);if(result.success){regroup(result);$scope.$safeApply(function(){$.each(result.dataList,function(index,data){guids[data.Guid]&&$.each(guids[data.Guid],function(index,award){updataYKY(data,award,true)})})})}}})}$scope.selectYKYCoupon=function(award){if(award.guid&&award.$disabled){return}var poupUpBox=top.$("#poup_selectYKYCouponBox");var defData={Guid:award.guid};var crrData=defData;if(poupUpBox.length>0){poupUpBox.remove()}poupUpBox=HdPortal.poupUpBox('<style>#poup_selectYKYCouponBox .poupBottom .icon{display: none;}#poup_selectYKYCouponBox .contentBox .center{max-height: 500px;overflow-y: auto;}#poup_selectYKYCouponBox .contentBox tr td{text-align: center;}#poup_selectYKYCouponBox .contentBox tr .select{width: 80px;height: 25px;border: 1px solid #CCCCCC;display: inline-block;cursor: pointer;line-height: 25px;}#poup_selectYKYCouponBox .contentBox tr .select.selected{border-color: #74B5E5;}#poup_selectYKYCouponBox .contentBox tr .select.disabled{background: #CCCCCC;cursor: auto;}#poup_selectYKYCouponBox .contentBox tr th.nameColumn{width: 200px;}</style><div class="contentBox faiTableType2"></div>',2,"请选择奖品","width: 800px;",true,"selectYKYCouponBox",function(){if(crrData!==defData){$scope.$safeApply(function(){updataYKY(crrData,award)})}});var contentBox=poupUpBox.find(".contentBox");contentBox.faiTable({tableColumn:{colClass:"",columns:[{key:"showIndex",name:"卡券ID",extData:function(back,data){return back+1}},{key:"Title",name:"奖品名称",colClass:"nameColumn",},{key:"TypeName",name:"奖品类型",},{key:"TotalCount",name:"库存",extData:function(back,data){return back-data.SendCount}},{key:"operate",name:"操作",extData:function(back,data){if(data.Guid){if(crrData.Guid===data.Guid){crrData=data;return'<div class="select selected">已选择</div>'}else{for(var i=0;i<game._setting.an;i++){var checkAward=awardList[i];if(award!==checkAward&&checkAward.guid==data.Guid){return'<div class="select disabled">选择</div>'}}}}return'<div class="select">选择</div>'}}]},bottom:{show:true,showTotal:true,showAllTotal:true,showPage:true,showPageJump:true,showPageNumSelect:true,},ajaxPage:{url:HdPortal.versionURL+"/ajax/hdportal_h.jsp?cmd=getYKYCouponList",regroup:regroup,},primaryKey:"Guid",page:{showCountList:[10,15,30],showCount:10},itemHover:true,});contentBox.on("click","tr .select",function(){var elem=$(this);if(!elem.hasClass("selected")&&!elem.hasClass("disabled")){var lastSelected=contentBox.find("tr .select.selected");if(lastSelected.length>0){lastSelected.removeClass("selected").text("选择")}crrData=contentBox.faiTable("getPrimaryKeyData",elem.closest("tr").attr("Guid"),true);elem.addClass("selected").text("已选择")}});poupUpBox.on("poupBox_close",function(){contentBox.faiTable("abortAjaxPage")})};function regroup(rt){if(rt.success&&rt.data){rt.totalCount=rt.data.total;rt.dataList=rt.data.data}}function updataYKY(data,award,notCount){if(!data||!award){return}award.guid=data.Guid;award.name=data.Title;!award.ykydata&&(award.ykydata={});award.ykydata.TypeName=data.TypeName;if(!notCount){award.ykydata.$TotalCount=data.TotalCount-data.SendCount}}})()}]);var awardNameList={2:["价值100元礼品","价值50元礼品","价值10元礼品","价值5元小礼品","价值5元小礼品","价值5元小礼品","价值5元小礼品","价值5元小礼品","价值5元小礼品"],0:["100元优惠券","50元优惠券","10元优惠券","5元优惠券","5元优惠券","5元优惠券","5元优惠券","5元优惠券","5元优惠券"],1:["100元优惠券","50元优惠券","10元优惠券","5元优惠券","5元优惠券","5元优惠券","5元优惠券","5元优惠券","5元优惠券"],5:["100元微信现金红包","50元微信现金红包","10元微信现金红包","5元微信现金红包","5元微信现金红包","5元微信现金红包","5元微信现金红包","5元微信现金红包","5元微信现金红包"],4:["价值100元奖品","价值50元奖品","价值10元奖品","价值5元奖品","价值5元奖品","价值5元奖品","价值5元奖品","价值5元奖品","价值5元奖品"],6:[],7:[],8:[],9:[]};app.controller("awardCtrl",["$rootScope","$scope","watch","HdGameDef","$sce",function($root,$scope,watch,HdGameDef,$sce){var index=$scope.index=$scope.$index;var award=$scope.award;var awardDef=$scope.awardDef=gameDef._awardList[index];var awardOld=$scope.awardOld=gameOld._awardList[index];var isComfort=$scope.isComfort=!award.level;var awardDetail=$("#awardDetail");var awardSetting=awardDetail.find(".awardSettingBox").eq(index);watch=watch.$new($scope);var rt=function(){$scope.$emit("$awardCtrlEnd",watch,awardSetting)};$scope.log=function(e){console.log(e)};$scope.awardLast=function(){return gameLast._awardList[index]};watch(isComfort?"game.$saveComfort":"index < game._setting.max_an",function(newValue,oldValue){award.$disabled=game.$$isPublish&&newValue});if(game.$$isYKY){watch.filterChecked(function(e){if(!["award.style","award.amount","award.guid","award.amount-game.$$prizedNum[award.level]>award.ykydata.$TotalCount"].contains(e)){return false}});watch("award.amount-game.$$prizedNum[award.level]>award.ykydata.$TotalCount",function(newValue,oldValue){var input=awardSetting.find(game.$$isPublish?(g_isVersion3?".awardAmountBox":".allAwardAmountBox"):(game.style==71?".groupAwardAmount":".awardAmount"));if(newValue){ERR.addErr(input,"{ykyCount,-2}|奖品数量不能大于卡券库存");return"award.sykydata.$TotalCount"}ERR.removeErr(input,"ykyCount")})();watch("award.guid",function(newValue,oldValue,scope,isSave){if(g_isNewOpt||!award.$isOpenAward||(!isSave&&newValue===oldValue)){return}var input=awardSetting.find(".awardDescribe");if(newValue==undefined){award.name="";ERR.addErr(input,"奖项名称不能为空",null,"margin-left:"+g_awardMg+"px;");return{cmd:"breakSave",msg:"请选择奖项名称",fn:selectAwardTab($scope,index,input)}}ERR.removeErr(input)})();watch("award.name",function(newValue,oldValue){!arguments[3]&&(operateFlagList[10]=true);$$(function(){if(index==0&&game.style==48){$$(".hd-imgBoxer .hd-giftName").eq(index).text(newValue);$$(".awardInfoBox .hd-theGiftName").text(newValue)}$$(".awardLine .award").eq(index).text(newValue);$$(".awardItem").eq(index).find(".award").text(newValue)})})}else{watch(["award.name","award.genewxcard","award.awardtype","award.jzCouponId"],function(newValue,oldValue,scope,isSave){if(newValue===oldValue){return}if(newValue[2]==9){if(g_isNewOpt||!award.$isOpenAward||(!isSave&&((newValue[3]===oldValue[3])||(newValue[3]===-1)))){return}else{var input=awardSetting.find(".JZCouponsInput");var v2=oldValue;if((newValue[3]==undefined)||(newValue[3]==-1)){award.name="";ERR.addErr(input,"奖项名称不能为空",null,"margin-left:"+g_awardMg+"px;");return{cmd:"breakSave",msg:"请选择奖项名称",fn:selectAwardTab($scope,index,input)}}ERR.removeErr(input)}}else{var input=awardSetting.find(".JZCouponsInput");ERR.removeErr(input)}var input=awardSetting.find(".awardDescribe");if(input.length>1){input=newValue[2]==9?input.eq(1):input.eq(0)}if(newValue[1]){if(!HdPortal.checkMaxLen(newValue[0],game.$$afterWxCard?18:30,input,"noLimitType",false)){return"$old"}}else{if(!HdPortal.checkMaxLenForEditActive(newValue[0],game.$$afterWxCard?24:30,input,false)){return"$old"}}!arguments[3]&&(operateFlagList[10]=true);$$(function(){if(index==0&&game.style==48){$$(".hd-imgBoxer .hd-giftName").eq(index).text(newValue[0]);$$(".awardInfoBox .hd-theGiftName").text(newValue[0])}if(game.style==75){$$("#myAwardInfo .awardNameDef").eq(index).text(newValue[0])}$$(".awardLine .award").eq(index).text(newValue[0]);$$(".awardItem").eq(index).find(".award").text(newValue[0])})})()}if(award.awardtype==3){awardType=2}if(!isComfort){watch("award.amount",function(newValue,oldValue){if(!game.$$isPublish||award.level>game._setting.max_an){award.$isExcelCode=game.$$createTime>1488933900000&&newValue>=game.$$exportThreshold}if(newValue===oldValue){return}!arguments[3]&&(operateFlagList[11]=true);if(!game.$$isPublish||award.level>game._setting.max_an){if(Edit.checkAmountTotal()){return"$old"}}Edit.checkPasswordredTotal(index,true);if(game.style==71&&game.$getGroupMemberNum()){award.groupAwardAmount=newValue/game.$getGroupMemberNum()}})();watch(["award.awardtype","award.amount","game._setting.hbPreCount","game._setting.giftPreCount"],function(newValue,oldValue){var isHb=false;var isGift=false;if(oldValue[0]==5||newValue[0]==5){isHb=true}if(oldValue[0]==6||oldValue[0]==7||oldValue[0]==8||newValue[0]==6||newValue[0]==7||newValue[0]==8){isGift=true}if(isHb||isGift||newValue[2]==2||newValue[3]==2){setTimeout(function(){var prdMsgAmount=Edit.sumAmountTotal(5);$("#pdtAmount").html(prdMsgAmount);$("#hbPreSetBox .rechargeWarn").toggle($("#rmdAmount").text()<prdMsgAmount);var giftPrdMsgAmount=Edit.sumAmountTotal(6)+Edit.sumAmountTotal(7)+Edit.sumAmountTotal(8);$("#giftPdtAmount").html(giftPrdMsgAmount);$("#giftPreSetBox .rechargeWarn").toggle($("#rmdAmount").text()<giftPrdMsgAmount)},0)}if(newValue[2]==oldValue[2]){HdPortal.logDog(1000153,60)}});if(game.style==48||game.style==67||game.style==77){watch("award.awardprice",function(newValue,oldValue){if(newValue===oldValue){return}if(checkPrice(".awardPrice","奖品原价必须大于砍价目标")){return"$old"}if(!angular.isDefined(newValue)||newValue<0){ERR.addErr(awardSetting.find(".awardPrice"),"输入不能为空",awardDetail,"margin-left:"+g_awardMg+"px;");return"$old"}ERR.removeErr(awardSetting.find(".awardPrice"));if(index==0){$$(function(){$$(".theControlMoney").text(newValue)})}})();watch("award.cutdownpricetarget",function(newValue,oldValue){if(newValue===oldValue){return}if(checkPrice(".awardTarget","砍价目标必须小于奖品原价")){return"$old"}if(!angular.isDefined(newValue)||newValue<0){ERR.addErr(awardSetting.find(".awardTarget"),"输入不能为空",awardDetail,"margin-left:"+g_awardMg+"px;");return"$old"}ERR.removeErr(awardSetting.find(".awardTarget"));if(index==0){$$(function(){$$(".theTargetPrice").text(newValue)})}})();watch("award.needhelppeople",function(newValue,oldValue){if(newValue===oldValue){return}if(newValue>5&&game.$$verInfo.realVer==0&&!game.$$isOem&&game.createTime>1528252200000&&game.style==67){if(!(game.$$isPublish&&award.level<=gameLast._setting.an)){ERR.addErr(awardSetting.find(".needHelpPeople"),"免费版最大需砍次数为5次",awardDetail,"margin-left:120px;");return"$old"}}if(!angular.isDefined(newValue)||newValue<1||newValue>999){ERR.addErr(awardSetting.find(".needHelpPeople"),"请输入数字1~999",awardDetail,"margin-left:120px;");return"$old"}ERR.removeErr(awardSetting.find(".needHelpPeople"))})();function checkPrice(input,msg){if(award.awardprice<=award.cutdownpricetarget){ERR.addErr(awardSetting.find(input),"{checkPrice,1}|"+msg,awardDetail,"margin-left: "+g_awardMg+"px;");return true}ERR.removeErr(awardSetting.find(".awardPrice,.awardTarget"),"checkPrice");return false}}if(game.$$isAwardWithPot){watch("award.pot",function(newValue,oldValue){if(newValue===oldValue){return}return checkedPotTotal()})()}}else{watch("award.comNum",function(newValue,oldValue){if(newValue===oldValue){return}!arguments[3]&&(operateFlagList[11]=true);if(!game.$$isPublish){var inputs=game.style==71?$(".groupAwardAmount").eq(8):$(".awardAmount").eq(8);if(newValue>999999){ERR.addErr(inputs,"安慰奖限制数量不超过999,999份",awardDetail,"margin-left: "+g_awardMg+"px;");return"$old"}ERR.removeErr(inputs)}})();$("#anweiCuscode").on("blur",function(e){checkCuscode(8,"",false,"")})}$scope.$watchGroup(["award.awardtype","award.cashtype","award.payment"],function(newValue,oldValue){award.$lastType=award.$type;award.$type=$.extend(true,{},game.$$awardTypeInfo.def,game.$$awardTypeInfo[newValue[0]]);if(newValue[0]==2&&game.$$afterWxCard){$.extend(award.$type,award.$type[newValue[1]]);if(newValue[1]==1){$.extend(award.$type,award.$type[award.onlinect])}}if(newValue[0]==5){$.extend(award.$type,award.$type[newValue[2]])}if(newValue[0]==6||newValue[0]==7||newValue[0]==8){$.extend(award.$type,award.$type[newValue[2]])}award.$type.name=awardNameList[newValue[0]][index];!game.$$afterWxCard&&(award.$type.btn="");if(award.$type.sitetype=="url"){award.$type.$cashsiteurl=award.$type.cashsite;award.$type.cashsite=""}if(newValue===oldValue){award.$lastType=award.$type;award.$cashsiteurl=award.$type.sitetype=="url"?award.cashsite:"http://";award.cashsite=award.$type.sitetype=="text"?award.cashsite:"请填写您的兑奖地址或者门店地址";return}$.each(["name","cashsite","$cashsiteurl","opti"],function(index,key){if(award.$type[key]&&award.$lastType[key]&&award[key]==award.$lastType[key]){award[key]=award.$type[key]}})});$scope.$watchGroup(["game._setting.linkInfotype","award.amount","game._flag.f16","award.comLimitNum","award.comNum","game.gameType","award.oplink"],function(newValue,oldValue){game.$needMsgTips="";var total=0;var isComLimit=awardList[8].comLimitNum;var comLimitNum=awardList[8].comNum;for(var i=0;i<8;i++){if(!game._setting.linkInfoAll&&!awardList[i].oplink){continue}if(i<game._setting.an){total+=awardList[i].amount}else{if(game.$$isPublish){total+=game.$$prizedNum[i]}}}if(game.$$data.isPaymentGame){game.$needMsgTips="预计短信数量约等于活动参与人数，可根据活动规模预测需要短信数量";game.$needMsgConut=50}else{if(newValue[0]==2||newValue[0]==3){game.$needMsgTips="预计短信数量约等于活动参与人数，可根据活动规模预测需要短信数量"}else{if(newValue[0]==4){if(!newValue[2]){game.$needMsgTips=total+"条（该预测与奖品数量相关，需先进行奖项设置）"}else{if(newValue[2]&&isComLimit){total+=comLimitNum;game.$needMsgTips=total+"条（该预测与奖品数量相关，需先进行奖项设置）"}else{if(newValue[2]&&!isComLimit){game.$needMsgTips="预计短信数量约等于完成活动人数，可根据活动规模预测需要短信数量"}}}}}if(newValue[0]==2||newValue[0]==3||(newValue[0]==4&&newValue[2]&&!isComLimit)){game.$needMsgConut=50}else{if((newValue[0]==4&&!newValue[2])||(newValue[0]==4&&newValue[2]&&isComLimit)){game.$needMsgConut=total}}}});watch(isComfort?"game._flag.f16":"index < game._setting.an",function(newValue,oldValue){award.$isOpenAward=newValue});$scope.$$postDigest(function(){awardSetting.find(".cusCodeBox").change(function(){$scope.delCusCode(index);isChangeCusCode=true});if(!HdPortal.isOpenNewCusCode){awardSetting.find(".checkCuscodeBtn").click(function(){$(this).text("检测中...");awardSetting.find(".cusCodeBox").attr("disabled","disabled");ERR.addErr($(this));$(this).removeClass("inputErr");$(".tipsArrow").hide();checkCuscode(index)})}if(!game.$$isPublish){return}award.$isAddAmount=false;var amountCancelBtn=awardSetting.find(".amountCancelBtn");var setAwardAmountBox=awardSetting.find(".setAwardAmountBox");var amountModify=awardSetting.find(".amountModify");var addCuscode=awardSetting.find(".addCuscode");awardSetting.find(".amountIcon").on("click",function(){toggleLock(setAwardAmountBox,true);addCuscodeVal=addCuscode.val();$("body").off("click",cancel).on("click",cancel)});amountCancelBtn.on("click",function(){toggleLock(setAwardAmountBox,false);if(ERR.hasErr(setAwardAmountBox.find(".addCuscodeBox"),true)){addCuscode.val("");setAwardAmountBox.find(".addCuscodeBox .tipsColor").removeClass("inputErrMsg").html("8,000个以上券号请分批添加一行一个券号，请输入需要增加的券号");ERR.removeErr(addCuscode)}ERR.removeErr(amountModify)});function cancel(e){if($(e.target).closest(".setAwardAmountBox,.awardAmountBox").length==0){amountCancelBtn.click();$("body").off("click",cancel)}}awardSetting.find(".amountModifyBtn").on("click",function(){if(award.iscuscode&&award.$isAddAmount&&!award.$type.isJZcoupon&&!award.$type.isHdGift){checkCuscode(index,function(i,succeed){if(!succeed){return}top.HdPortal.wxCardProgress.init(true,100,200,"正在导入券号");var theNewAddVal=$(".awardSettingBox .addCuscode").eq(index).val();var cusCodes=getCodeListByVal(theNewAddVal);var cusVersList=[];var theVersion=award.version;if(game.$$isOpenNewCuscode){var tmpCode="";$.each(awardList,function(theIndex,award){if(award.iscuscode&&theIndex<game._setting.an){cusVersList.push({version:award.version,level:(theIndex+1)});if(award.cuscodes&&cusCodes){for(var i=0;i<award.cuscodes.length;++i){if(cusCodes.contains(award.cuscodes[i])){tmpCode=award.cuscodes[i];break}}}}});if(tmpCode!=""){var tipsColor=$(".addCuscodeBox .tipsColor").eq(index);tipsColor.addClass("inputErrMsg");tipsColor.html("含有重复自定义兑奖码:"+tmpCode);ERR.addErr($(".addCuscode").eq(index));top.HdPortal.wxCardProgress.end();return}}$.ajax({url:"/ajax/advanceUpload.jsp?cmd=uploadCustomCode&gameid="+game.id+"&level="+award.level+"&amount="+award.amount,type:"post",data:{customs:JSON.stringify(cusCodes),versions:JSON.stringify(cusVersList),version:theVersion},success:function(result){top.HdPortal.wxCardProgress.end();result=$.parseJSON(result);var tipsColor=$(".addCuscodeBox .tipsColor").eq(index);if(result.success){$scope.$safeApply(amountModifyFn);award.cuscodes=$.makeArray(cusCodes,award.cuscodes);tipsColor.removeClass("inputErrMsg");if(index!=8){tipsColor.html("8,000个以上券号请分批添加<br />一行一个券号，请输入需要增加的券号")}ERR.removeErr($(".addCuscode").eq(index))}else{tipsColor.addClass("inputErrMsg");tipsColor.html(result.msg);ERR.addErr($(".addCuscode").eq(index));return}}})})}else{$scope.$safeApply(amountModifyFn)}});function amountModifyFn(){var thisCusCodeList,addAmount=0;if(award.iscuscode&&award.$isAddAmount&&!award.$type.isJZcoupon&&!award.$type.isHdGift){addAmount=(thisCusCodeList=getCodeListByVal(addCuscode.val())).length}else{addAmount=hp.parseInt($.trim(amountModify.val()),0);if(game.style==71){addAmount=addAmount*game.$getGroupMemberNum()}}ERR.removeErr(addCuscode);if(!award.$isAddAmount){addAmount=-addAmount}var amountKey=isComfort?"comNum":"amount";if(addAmount<0&&award[amountKey]+addAmount<game.$$prizedNum[index]){ERR.addErr(amountModify,"奖品剩余数量不能少于0",awardDetail,"margin-left:0px;");return}ERR.removeErr(amountModify);var amount;if(isComfort){amount=Math.max(award[amountKey],game.$$prizedNum[index])+addAmount;if(amount>999999){ERR.addErr(amountModify,"安慰奖限制数量不超过999,999份",awardDetail,"margin-left:0px;");return}}else{amount=award[amountKey]+addAmount;if(addAmount>0&&Edit.checkAmountTotal(addAmount)){ERR.addErr(amountModify,"{amountTotal,-1}|活动奖品总数量超过最大限制"+addCommas(game.$$verInfo.awardAmountLimit)+"份",awardDetail,"margin-left:0px;");return}}ERR.removeErr(amountModify,"amountTotal");award[amountKey]=amount;amountCancelBtn.click();addCuscode.val("");thisCusCodeList&&$.each(thisCusCodeList,function(i,val){var info={level:index+1,custom:thisCusCodeList[i],};cusCodelist.push(info);!game.$$addCusCodeList&&(game.$$addCusCodeList=[]);game.$$addCusCodeList.push(info)});if(award.iscuscode&&!award.$isAddAmount&&$.isArray(award.cuscodes)){award.cuscodes.splice(addAmount,-addAmount)}Edit.checkPasswordredTotal(index,true)}amountModify.on("blur",function(){if($.trim($(this).val()).length==0){$(this).val(0)}})});$scope.addSellMoney=function(){if(award.$ptSellMoneys.length>=5){return HdPortal.hdShowMsg("error","最多只能设置5个价位",true)}award.$ptSellMoneys.push({})};$scope.deleteSellMoney=function(index){award.$ptSellMoneys.splice(index,1)};if(game.$$data.isPaymentGame){return rt()}$scope.revertWxCard=function(){award.genewxcard=false;if(award.awardtype==4){award.awardtype=2}};$scope.cancelVerTip=function(cid,award){var isSetCancelVerTip=$.cookie(cid+"isSetCancelVerTip");if(isSetCancelVerTip){return}var rbFlag=true;var options={name:"",content:'<div class="cancelVerTip"><p class="p1">开启自助核销有被不法分子伪造中奖页面冒领奖品的风险。</p><p class="p2">建议贵重的奖品不要开启自助核销以规避风险</p><p><input name="checkbox" class="cancelVerTip_cb" type="checkbox" value="checkbox"/><label class="labelText">我已明确了解其中风险，确定开启自助核销</label></p></div>',hasTitle:true,hasBottom:true,title:"风险提示",width:464,height:0,showMask:true,confirmBtnName:"确认开启",cancelBtnName:"取消",confirmFun:function(boxObj,msg){if(!boxObj.find(".cancelVerTip_cb").prop("checked")){HdPortal.hdShowMsg("error","请先同意条款",true);return"stop"}$.cookie(cid+"isSetCancelVerTip",true,{expires:7,domain:document.domain,path:"/"});rbFlag=false},cancelFun:null,closeFun:function(){if(rbFlag){$root.$safeApply(function(){award.iscancelver=false})}},styles:"",contentStyles:"",hasAnimate:true,isOneBottomBtn:true};var box=HdPortal.popup(options);box.find(".p1").css({fontSize:"14px",color:"#949494",lineHeight:"16px"});box.find(".p2").css({fontSize:"14px",color:"red",lineHeight:"16px",margin:"18px 0px"});box.find(".labelText").css({fontSize:"14px",color:"#74b7e6",lineHeight:"16px",textIndent:"6px",marginBottom:"20px"});var confirmBtn=box.find(".poupBtn.main-Button.confirmBtn");confirmBtn.css({lineHeight:"36px",width:"128px",cursor:"pointer"}).addClass("disabled");box.find(".poupContent").css({minHeight:"100px"});var selectFlag=false;box.find(".labelText").click(function(){selectFlag=!selectFlag;if(selectFlag){box.find(".cancelVerTip_cb").prop("checked",true);confirmBtn.removeClass("disabled")}else{box.find(".cancelVerTip_cb").prop("checked",false);confirmBtn.addClass("disabled")}})};watch("award.$disabled && !awardLast().genewxcard",function(newValue,oldValue){$scope.canOpenKq=game.$$hasKqOpen&&!(game.$$isPublish&&newValue);if(newValue===oldValue){return}if(!$scope.canOpenKq){$scope.revertWxCard()}});award.$$awardTypeList=hdFai.HdList("val",[{val:2,name:game.$$afterWxCard?"礼品":"实物礼品"},{val:0,name:"门店优惠券"},{val:1,name:"电商优惠券"},]);if(game.$$isOpenGift&&!isComfort){award.$$awardTypeList.add({val:6,name:"流量"});award.$$awardTypeList.add({val:7,name:"话费"});award.$$awardTypeList.add({val:8,name:"视频会员",hot:game.$$isOem?false:true})}if(game.$$isOpenRedPacket&&!isComfort&&game.$$afterWxCard&&angular.isDefined(award.passwordrednum)){award.$$awardTypeList.add({val:5,name:"微信"+(HdPortal._isInnerAccount?"现金":"口令")+"红包",ver:HdPortal.hdVer.BJ,srcId:9})}if(game.$$afterWXCardModify&&!isComfort){award.$$awardTypeList.add({val:4,name:"微信优惠券",ver:HdPortal.hdVer.BJ,srcId:13})}if(!game.$$isOem&&game.$$jzFlag!=-500&&game.$$jzFlag!=-400&&!isComfort){award.$$awardTypeList.add({val:9,name:"凡科建站商城优惠券"})}watch("award.storeType",function(newValue,oldValue){updateUseStore()})();watch("award.storesIds",function(newValue,oldValue){updateUseStore();if(newValue===oldValue||!award.$isOpenAward){return}return checkStoreIds()})();function checkStoreIds(){var input=awardSetting.find(".storeWrap");if(award.cashtype==2&&award.storeType==3&&(!award.storesIds||award.storesIds.length<1)){ERR.addErr(input);return{cmd:"breakSave",msg:"尚有信息未填写或填写错误，请先填写或修改",fn:selectAwardTab($scope,index,input)}}ERR.removeErr(input)}function updateUseStore(){var useStoreList;if(award.storeType==2||award.storeType==5){useStoreList=game.$$allStoreList}else{if(award.storeType==3){useStoreList=award.cloneStores}else{if(award.storeType==4){useStoreList=[game.$$currStore]}}}award.$$useStoreList=useStoreList}$scope.showPopStoreListIframe=function(){var poupUpBox=HdPortal.poupUpBox("",2,"选择门店","width:660px;position:fixed;",true,"poupStoreListWrap",function(_poupUpBox){var storeList=_poupUpBox.find(".chooseStoreFramePage")[0].contentWindow.reStore();var storesIds=[];$.each(storeList,function(i,store){storesIds.push(store.id)});$scope.$safeApply(function(){award.storesIds=storesIds;award.cloneStores=storeList})});if(top.$(".chooseStoreFramePage").length==0){var iframeSrc=(g_isVersion3?"../":"")+"manage/storeList.jsp";if(award.storesIds&&award.storesIds.length>0){iframeSrc=iframeSrc+"?storeIds="+$.toJSON(award.storesIds)}top.$("#poup_poupStoreListWrap .poupContent").append('<iframe class="chooseStoreFramePage" name="chooseStoreFramePage" src="'+iframeSrc+'" style="width: 612px;height: 400px;"></iframe>')}};$scope.toggleAwardTypeBox=function(type){if(award.$disabled){return}$scope.showAwardTypeBox=!$scope.showAwardTypeBox;$scope.showGiftTypeBox=false};!award.$disabled&&$(document).on("click",function(event){if(!$scope.showAwardTypeBox){return}if($(event.target).closest(".awardTypeValue,.awardTypeBox").length){return}$scope.$safeApply(function(){$scope.showAwardTypeBox=false})});$scope.toggleGiftTypeBox=function(type){if(award.$disabled){return}$scope.showGiftTypeBox=!$scope.showGiftTypeBox;$scope.showAwardTypeBox=false};!award.$disabled&&$(document).on("click",function(event){if(!$scope.showGiftTypeBox){return}if($(event.target).closest(".awardTypeValue,.awardTypeBox").length){return}$scope.$safeApply(function(){$scope.showGiftTypeBox=false})});$scope.selectAwardType=function(type,$event){if(award.$disabled){return}$event&&$event.stopPropagation();var crrItem=award.$$awardTypeList.getByName(type);if(!crrItem){return}if(game.$$verInfo.authVer<crrItem.ver){var verInfo=game.$$verInfo.map[crrItem.ver];var theTipsText=HdPortal.noSupportTipA.replace(/HdPortal\.logDog\(\)/,"Edit.logDogNer(3,"+(crrItem.srcId||0)+")");HdPortal.hdShowMsg("error",crrItem.name+"为"+verInfo.name+"功能"+(!game.$$isOem?theTipsText:"，请先升级活动为"+verInfo.name));return}if(!HdPortal._isInnerAccount&&type==5){if(isComfort){return}if(!game.$$hasHbOpen){HdPortal.hdShowMsg("error","请先到个人中心开通公众号核销功能");return}$scope.revertWxCard();award.payment=0}if(type==4){if(isComfort){return}if(!game.$$hasKqOpen){HdPortal.hdShowMsg("error","请先到个人中心开通微信卡券功能");return}}if(type==9){if(game.$$jzFlag==-501){HdPortal.hdShowMsg("error","请先到凡科网站管理中开启商城功能和优惠券功能");return}else{if(game.$$jzFlag==-502){HdPortal.hdShowMsg("error","请先到凡科网站管理中开启优惠券功能");return}}}award.awardtype=type;$scope.showAwardTypeBox=false};$scope.selectGiftType=function(val,index,$event){$event&&$event.stopPropagation();for(var i=0;i<game.$$giftTypeDef[index].length;i++){if(val==game.$$giftTypeDef[index][i].val){award.giftTypeItem=game.$$giftTypeDef[index][i];award.giftType=award.giftTypeItem.val}}award.name=award.giftTypeItem.name;$scope.showGiftTypeBox=false};HdPortal._isInnerAccount&&$scope.$$postDigest(function(){if(!g_isVersion3){HdPortal.hoverTipsBox.link({agent:awardSetting.find(".invalidTipsPayment"),target:function(){return $(this).find(".icon")}},"up","需要到个人中心开通公众号核销功<br>能后方可正常使用该功能")}showTipsMsg("#followPayment"+index,"要选择关注后领取，请先到个人中心开通公众号核销功能");showTipsMsg("#followGetment"+index,"要选择关注后兑奖，请先到个人中心开通公众号核销功能");function showTipsMsg(id,msg){awardSetting.find(id+"+label").on("click",function(){if($(this).prev(id+":disabled").length){HdPortal.hdShowMsg("error",msg)}})}});watch("award.isOpenHostInfo",function(newValue,oldValue){if(award.isOpenHostInfo===undefined){award.isOpenHostInfo=true}var hasOpen=false;for(var i=0;i<game._setting.an;i++){var awardItem=awardList[i];var isOpenHostInfo=awardItem.isOpenHostInfo;if(isOpenHostInfo){hasOpen=true}}operateFlagList[76]=hasOpen;operateFlagList[77]=!hasOpen});watch("award.awardtype",function(newValue,oldValue){awardSetting.find(".codeLimitLen").text(newValue==4?"20":"40");var isGiftType=(newValue==6||newValue==7||newValue==8);game.$hasRedPacketType=HdPortal.setFlag(game.$hasRedPacketType,1<<index,newValue==5);game.$hasGiftType=HdPortal.setFlag(game.$hasGiftType,1<<index,isGiftType);if(isComfort&&(newValue==5||isGiftType)){award.awardtype=awardDef.awardtype;return}if(!game.$$isOpenGift&&game.$$isPublish&&newValue==6){award.$$awardTypeList.add({val:6,name:"流量"})}if(!game.$$isOpenGift&&game.$$isPublish&&newValue==7){award.$$awardTypeList.add({val:7,name:"话费"})}if(!game.$$isOpenGift&&game.$$isPublish&&newValue==8){award.$$awardTypeList.add({val:8,name:"视频会员",hot:game.$$isOem?false:true})}award.$awardTypeItem=award.$$awardTypeList.getByName(newValue);if(!award.$awardTypeItem){return(award.awardtype=2)}award.$checkedType=newValue;if(newValue==4||oldValue==4){award.genewxcard=newValue==4;if(award.genewxcard&&award.attention==3){award.attention=1}}game._flagC.f32=true;for(var i=0;i<game._setting.an;i++){var awardItem=awardList[i];var awardtype=awardItem.awardtype;if(awardtype==4){game._flagC.f32=false}}if((newValue==5||newValue==6||newValue==7||newValue==8||newValue==9)&&award.iscuscode){award.iscuscode=false}if(newValue===oldValue){return}operateFlagList[9]=true;if(newValue==5||oldValue==5){Edit.checkPasswordredTotal()}if(newValue==6||newValue==7||newValue==8){award.giftTypeItem=game.$$giftTypeDef[newValue][0];award.giftType=award.giftTypeItem.val;award.name=award.giftTypeItem.name}else{award.name=awardNameList[newValue][index]}if(newValue==9){$$(function(){$$("#awardDetailBox #forJZCouponBg").show()});award.needlessconsume=true}else{$$(function(){$$("#awardDetailBox #forJZCouponBg").hide()});award.needlessconsume=false;award.jzCouponId=-1;if(award.jzData){award.jzData={}}}});watch(["award.giftType","award.$type.isHdGift && award.amount"],function(newValue,oldValue){var ival=parseInt(newValue[1]);if(oldValue[1]===undefined&&isNaN(ival)){return}$.ajax({type:"post",url:HdPortal.versionURL+"/ajax/hdgift_h.jsp?cmd=getAssetAmount&storeId="+HdPortal.storeId+"&areaId="+HdPortal.areaId,error:function(){HdPortal.hdShowMsg("error","服务繁忙，请稍候重试",false)},success:function(data){var obj=$.parseJSON(data);if(obj.success){Edit.checkHdGiftTotal(obj.data,index)}}})});if(game.$$afterWxCard){awardSetting.on("click",'input[type="radio"]:disabled.cashWx+label',function(){var str="要开启公众号兑奖，请先到个人中心开通公众号核销功能";var award=awardList[game.$checkeIndex];HdPortal.hdShowMsg("error",str)});awardSetting.on("click.cusAwardCode",'input[type="radio"]:disabled.cusAwardCode+label',function(){var str="要开启公众号兑奖，请先到个人中心开通公众号核销功能";var award=awardList[game.$checkeIndex]});watch("award.cashtype",function(newValue,oldValue){var isInit=newValue===oldValue;if(newValue==3&&!game.$$hasWXCash){if(!isInit){HdPortal.hdShowMsg("error","要开启公众号兑奖，请先到个人中心开通公众号核销功能")}award.cashtype=awardDef.cashtype==3?2:awardDef.cashtype}if(game.$$isNewSetGame){if(award.cashtype==3){award.$hasOpenWXpublic=true;award.iscuscode=false}else{award.$hasOpenWXpublic=false}}if(!isInit){operateFlagList[39]=true}})}watch(game.$$afterWxCard?'award.$type.qrcode != "auto" ? award.$type.qrcode : award.opqrc':"award.opqrc",function(newValue,oldValue){award.$opqrc=newValue});watch("award.$type.site",function(newValue,oldValue){$(".errSite").text(newValue)});watch("award.wxcardcomname",function(newValue,oldValue){if(newValue===oldValue||!award.genewxcard||!award.$isOpenAward){return}var input=$("#wxCardName"+index);if(!HdPortal.checkMaxLen(newValue,24,input,"noLimitType",false,"","margin-left:"+(game.$$afterWXCardModify?g_awardMg:8)+"px;")){return{cmd:"breakSave",msg:"尚有信息未填写或填写错误，请先填写或修改",fn:selectAwardTab($scope,index,input)}}})();award.$fixedBeginTermList=$root.getIntList(0,90);award.$fixedTermList=$root.getIntList(1,90);$scope.$$postDigest(function(){var startDate=awardSetting.find(".useCodeBeginTime");var endDate=awardSetting.find(".useCodeEndTime");startDate.datetimepicker({changeMonth:true,changeYear:true,dateFormat:"yy-mm-dd",timeText:"&nbsp;时间",hourText:"&nbsp;时",minuteText:"&nbsp;分",currentText:"现在",closeText:"确认",showTimepicker:false,buttonImage:"/image/ver/mianfei.png",}).change(function(event){Edit.watch("startDate"+index,$(this).val(),function(val,oldValue){if($.trim(val).length===0){return}$scope.$safeApply(function(){award.cbt=val+" 00:00:00"})});!event.isTrigger&&(operateFlagList[42]=true)});endDate.datetimepicker({changeMonth:true,changeYear:true,dateFormat:"yy-mm-dd",timeText:"&nbsp;时间",hourText:"&nbsp;时",minuteText:"&nbsp;分",currentText:"现在",closeText:"确认",showTimepicker:false,}).change(function(event){Edit.watch("endDate"+index,$(this).val(),function(val,oldValue){if($.trim(val).length===0){return}$scope.$safeApply(function(){award.cet=val+" 23:59:59"})});!event.isTrigger&&(operateFlagList[42]=true)});awardSetting.find(".termBox select").change(function(event){!event.isTrigger&&(operateFlagList[42]=true)});$scope.dateLimit={};$.each(["s_max","s_min","e_max","e_min"],function(i,v){var arr=v.split("_");var target=arr[0]=="s"?startDate:endDate;$scope.$watch("dateLimit."+arr[0]+arr[1],function(newValue,oldValue){if(!newValue){return}target.datetimepicker("option",arr[1]+"Date",new Date(newValue))})});$scope.$watchGroup(["award.cbt","award.genewxcard","awardLast().genewxcard&&awardLast().awardtype!=5","awardLast().cbt","awardLast().cet"],function(newValue,oldValue){var smax,smin,emax,emin,now=awardList.$$initTime;var strict=game.$$isPublish&&newValue[2];var sDate=getDate(newValue[0].substring(0,10));var oldsDate=getDate(newValue[3]);var oldeDate=getDate(newValue[4]);if(newValue===oldValue||watchList(newValue,oldValue,[1,2,3,4])){smax=getDateByYear(20);if(strict){smax=new Date(oldsDate);smin=new Date(oldsDate)}else{if(newValue[1]){smin=new Date(now.getTime())}else{smin=getDateByYear(-20)}}smax&&($scope.dateLimit.smax=smax.getTime());smin&&($scope.dateLimit.smin=smin.getTime())}emax=getDateByYear(20);if(sDate.getTime()>getDate(award.cet).getTime()||!strict){emin=sDate}else{emin=now;if(now.getTime()<oldeDate.getTime()){emin=oldeDate}else{if(now.getTime()<oldsDate.getTime()){emin=oldsDate}}}emax&&($scope.dateLimit.emax=emax.getTime());emin&&($scope.dateLimit.emin=emin.getTime())});if(game.$$isPublish){watch("awardLast().genewxcard && awardLast().awardtype != 5",function(newValue,oldValue){award.$fixedTermList=$root.getIntList(newValue?$scope.awardLast().cft:1,90);startDate.attr("disabled",newValue);awardSetting.find(".codeFixedBeginTerm").attr("disabled",newValue).toggleClass("disableBg",newValue)})}function getDate(str){if(!str){return}return new Date(str.replace(/-/g,"/"))}function getDateByYear(num){var target=new Date(awardList.$$initTime.getTime());target.setFullYear(target.getFullYear()+num);return target}function watchList(news,olds,keys){for(var i=0;i<keys.length;i++){if(news[keys[i]]!==olds[keys[i]]){return true}}return false}});watch("award.style",function(newValue,oldValue){if(newValue===oldValue){return}var input=awardSetting.find(".awardStyle");!arguments[3]&&(operateFlagList[39]=true);if(!HdPortal.checkMaxLenForEditActive(newValue,10,input,false)){return"$old"}$$(function(){if(game.style==75){$$("#myAwardInfo .awardLevel").eq(index).text(newValue)}$$("#awardLine .awardStyle").eq(index).text(newValue)})})();watch(["award.stl","award.awardtype"],function(newValue,oldValue){if(newValue===oldValue){return}var input=awardSetting.find(".awardSubTile");if(newValue[1]==4){if(!HdPortal.checkMaxLen(newValue[0],36,input,"noLimitType",true)){return"$old"}}else{if(!HdPortal.checkMaxLenForEditActive(newValue[0],36,input,true)){return"$old"}}!arguments[3]&&(operateFlagList[45]=true)})();watch(["award.opti","award.awardtype"],function(newValue,oldValue){if(newValue===oldValue){return}!arguments[3]&&(operateFlagList[40]=true);var input=awardSetting.find(".awardOptInfo");if(newValue[1]==4){if(!HdPortal.checkMaxLen(newValue[0],32,input,"noLimitType",false)){return"$old"}}else{if(!HdPortal.checkMaxLenForEditActive(newValue[0],32,input,false)){return"$old"}}award.$type.opti&&(award.$type.opti=newValue[0])})();watch("award.storeType == 1 && award.$type.sitetype == 'text'",function(newValue,oldValue){award.$siteEmptyLimit=newValue});var watchCashSite=function(e,selecter){watch(e,function(newValue,oldValue){var input=awardSetting.find(selecter);if(newValue===oldValue){return}if(award.$siteEmptyLimit&&$.trim(newValue).length==0){ERR.addErr(input,"<span class='errSite'>"+award.$type.site+"</span>不能为空",awardDetail,"margin-left: 0px;");return"$old"}ERR.removeErr(input)})()};var watchType=function(e,selecter){watch(e,function(newValue,oldValue){if(newValue==oldValue){return}var type;var input=awardSetting.find(selecter);if(e=="award.cashtype"){type=(newValue==2&&game.$cAward.storeType==1)}else{if(e=="award.awardtype"){type=((newValue==0||(newValue==2&&game.$cAward.cashtype==2))&&game.$cAward.storeType==1)}else{if(e=="award.storeType"){type=(newValue==1)}}}if(type){if($.trim(input.val()).length==0){ERR.addErr(input,"<span class='errSite'>"+award.$type.site+"</span>不能为空",awardDetail,"margin-left: 0px;")}}else{ERR.removeErr(input)}})};watchCashSite("award.cashsite",".awardCashSite");watchType("award.cashtype",".awardCashSite");watchType("award.awardtype",".awardCashSite");watchType("award.storeType",".awardCashSite");watch("award.$cashsiteurl",function(newValue,oldValue){if(newValue==oldValue){return}if(award.$type.sitetype=="url"&&award.cashsite!=award.$cashsiteurl){}oldValue&&(changeIsSave())});awardSetting.find(".awardCashSite,.awardCashSiteUrl").on("change",function(event){!event.isTrigger&&(operateFlagList[41]=true)});watch(["award.cashinfo","award.awardtype"],function(newValue,oldValue){if(newValue===oldValue){return}var input=awardSetting.find(".cashInfoContent");if(newValue[1]==4){if(!HdPortal.checkMaxLen(newValue[0],400,input,"noLimitType",true)){return"$old"}}else{if(!HdPortal.checkMaxLenForEditActive(newValue[0],400,input,true)){return"$old"}}operateFlagList[47]=true});award.$btn1="企业官网";award.$btn2="关注我们";watch("award.attention",function(newValue,oldValue){if(newValue===oldValue){return}if(newValue==2){award.$btn2=award.mun||"关注我们";award.btn=award.$btn1}else{if(newValue==3){award.$btn1=award.mun||"企业官网";award.btn=award.$btn2}}});watch(["award.btn","award.awardtype"],function(newValue,oldValue){var input=awardSetting.find(".awartBtnTitle");if(newValue[1]==4){if(!HdPortal.checkMaxLen(newValue[0],10,input,"noLimitType",false,"","margin-left:"+g_awardMg+"px;")){return"$old"}}else{if(!HdPortal.checkMaxLenForEditActive(newValue[0],10,input,false,"","margin-left:"+g_awardMg+"px;")){return"$old"}}});watch("award.servicepho",function(newValue,oldValue){if(newValue===oldValue){return}if(!HdPortal.checkMaxLen(newValue,25,awardSetting.find(".servicePhone"),"limitNumType",true)){return"$old"}operateFlagList[46]=true});watch("award.awardtype",function(newValue,oldValue){if(newValue===oldValue){return}if((newValue==3)||(newValue==5)){game._flagC.f4=true}else{game._flagC.f4=false}});$.each([award,awardOld,awardDef],function(index,info){if(info.continfo==0){info._continfo={f1:true,f2:true,f4:false,}}else{info._continfo={f1:hdFai.checkBit(info.continfo,1),f2:hdFai.checkBit(info.continfo,2),f4:hdFai.checkBit(info.continfo,4),}}});watch("award._continfo",function(newValue,oldValue){if(newValue===oldValue){return}var input=$("#contactBox"+index);var hasTrue=false;$.each(newValue,function(key,val){val&&(hasTrue=true)});var errEl=g_isVersion3?input.closest(".settingLine").find(".contactErr"):input.next(".contactErr");if(!hasTrue){ERR.addErr(input);errEl.show();return"$old"}ERR.removeErr(input);errEl.hide()},true)();$.each([award,awardOld,awardDef],function(index,info){info.$timeLimitSelAll=info.tlmt=="[8]";info._tlmt=[];if(info.$timeLimitSelAll){for(var i=0;i<7;i++){info._tlmt.push(true)}}else{var tlmt=$.parseJSON(info.tlmt);for(var i=0;i<7;i++){info._tlmt.push(tlmt.contains(i+1))}}});var updateTlmt=function(){if(award.$timeLimitSelAll){award.tlmt="[8]"}else{var tlmt=[];$.each(award._tlmt,function(index,val){val&&tlmt.push(index+1)});award.tlmt=$.toJSON(tlmt)}};watch("award._tlmt",function(newValue,oldValue){if(newValue===oldValue){return}if(!newValue.contains(true)){ERR.addErr($("#timeLimitSelBox"+index),"可用时段不能为空",awardDetail,"margin-left: "+g_awardMg+"px;","$sef");return"$old"}!arguments[3]&&(operateFlagList[44]=true);ERR.removeErr($("#timeLimitSelBox"+index));updateTlmt();hasWxCardInput=true},true)();watch("award.$timeLimitSelAll",function(newValue,oldValue){if(newValue===oldValue){return}operateFlagList[44]=true;updateTlmt();hasWxCardInput=true});!isComfort&&watch("award.iscuscode",function(newValue,oldValue){if(newValue===oldValue){return}operateFlagList[43]=true;newValue&&checkCuscode(game.$checkeIndex,"",true,"")});watch("award.passwordrednum",function(newValue,oldValue){if(newValue===oldValue){return}if(angular.isDefined(newValue)){var input=awardSetting.find(".passwordrednum");var errMsg=awardSetting.find(".redFixedNumLimit");if(newValue<100||newValue>20000){ERR.addErr(input);errMsg.addClass("errMsg")}else{if(input.hasClass("ERR_hasErr")){ERR.removeErr(input);errMsg.removeClass("errMsg")}}Edit.checkPasswordredTotal(index)}});watch(["award.hbAverage","award.floatBegin","award.floatEnd"],function(newValue,oldValue){var errorBit=false,errorInput=[false,false,false];if(newValue[1]>=newValue[0]){errorInput[1]=true;awardSetting.find(".minCount").show();awardSetting.find(".maxCount").hide()}else{awardSetting.find(".minCount").hide()}if(newValue[2]<=newValue[0]){errorInput[2]=true;awardSetting.find(".maxCount").show();awardSetting.find(".minCount").hide()}else{awardSetting.find(".maxCount").hide()}for(var ind=0;ind<3;ind++){if(angular.isDefined(newValue[ind])){var input=awardSetting.find(".randomRedNum"+ind);if(newValue[ind]<100||newValue[ind]>20000){errorInput[ind]=true;errorBit=true;awardSetting.find(".redNumLimit").addClass("errMsg")}if(!errorInput[ind]){ERR.removeErr(input)}else{ERR.addErr(input)}}}if(!errorBit){awardSetting.find(".redNumLimit").removeClass("errMsg")}Edit.checkPasswordredTotal(index)});watch("award.hbtype",function(newValue,oldValue){Edit.checkPasswordredTotal(index,true)});if(game.style==71){watch(["award.groupAwardAmount","game._setting.an"],function(newValue,oldValue){var postCount=0;for(var i=0;i<game._setting.an;i++){postCount+=awardList[i].groupAwardAmount}$$(function(){$$("#awardGroup").html(postCount)})});watch("award.groupAwardAmount",function(newValue,oldValue){award.amount=newValue*game.$getGroupMemberNum()});watch("game.$getGroupMemberNum()",function(newValue,oldValue){for(var i=0;i<game._setting.an;i++){awardList[i].amount=awardList[i].groupAwardAmount*newValue}})}if(!game.$$afterWxCard){watch("award.txn",function(newValue,oldValue){if(HdPortal.checkMaxLen(newValue,10,awardSetting.find(".awardTextTitle"),"noLimitType",false,false,"margin-left: "+g_awardMg+"px;")){return"$old"}})();watch("award.txc",function(newValue,oldValue){if(HdPortal.checkMaxLen(newValue,100,awardSetting.find(".awardTextContent"),"noLimitType",true)){return"$old"}})()}$scope.$$postDigest(function(){Edit.createHtml5Upload(0,awardSetting.find(".attentionImg img"),awardSetting.find("#AtentionBtn"+index),-1,true,"＋ 上传二维码",5000);Edit.createHtml5Upload(0,awardSetting.find(".onlineCashImg img"),awardSetting.find("#onlineWxCashUpBtn"+index),-1,true,"＋ 选择图片",5000);!isComfort&&Edit.createCustomUpload({groupId:0,uploadImg:null,uploadBtn:awardSetting.find(".uploadCusCode .upload"),from:-2,isPortal:true,buttonText:"上传文件",limit:10*1024,onSuccess:function(result,optall){uploadExcelCompelte($scope,result,optall)},url:function(){var cusVersList=[];if(game.$$isOpenNewCuscode){$.each(awardList,function(i,award){if(award.iscuscode&&i!=index&&i<game._setting.an){cusVersList.push({version:award.version,level:(i+1)})}})}return"/ajax/advanceUpload.jsp?cmd=uploadAwardCodeExcel&level="+(index+1)+"&id="+game.id+"&amount="+awardList[index].amount+"&versions="+JSON.stringify(cusVersList)},onStart:uploadExcelStart,index:index,})});return rt()}]);function selectAwardTab(scope,index,input){return function(){scope.$safeApply(function(){game.$tabSetting.select(1);game.$checkeIndex=index;Edit.scrollView(input)})}}function uploadExcelStart(upload,file,optall){var index=optall.index;var tip=$(".uploadCusCode").eq(index).find(".uploadTip");var type=file.name.substring(file.name.lastIndexOf("."),file.name.length);if(type!=".xls"&&type!=".xlsx"){tip.text("请选择后缀为xls或xlsx的Excel文件");if(!tip.hasClass("errMsg")){tip.removeClass("tipsColor").addClass("errMsg")}ERR.addErr($(".cusCodeBox").eq(index));upload.cancel();return}HdPortal.wxCardProgress.init(true,100,200,"正在导入券号，请勿关闭")}function uploadExcelCompelte($scope,result,optall){var index=optall.index;var uploadCusCode=$(".uploadCusCode").eq(index);var tip=uploadCusCode.find(".uploadTip");if(game.style==71){var amount=parseInt($(".awardSettingBox").eq(index).find(".groupAwardAmount").val().trim())*game.$getGroupMemberNum()}else{var amount=parseInt($(".awardSettingBox").eq(index).find(".awardAmount").val().trim())}result=$.parseJSON(result);if(result.success){tip.removeClass("inputErrMsg");ERR.removeErr(tip);ERR.removeErr($("#awardsSetting .cusCodeFile").eq(index));if(!game.$$isOpenNewCuscode){HdPortal.wxCardProgress.end(function(){$scope.$safeApply(function(){isChangeCusCode=true;if(result.codeList.length!=amount){tip.text("当前券号数量为"+result.codeList.length+"，与奖品数量不符");tip.addClass("errMsg").removeClass("tipsColor");ERR.addErr($("#awardsSetting .cusCodeFile").eq(index));return}awardList[index].excelName=result.filename;cusCodelist=cusCodelist.filter(function(item){return item.level!=index+1}).concat(result.codeList);uploadCusCode.find(".uploadBtn .uploadify-button").text("重新上传");uploadCusCode.find(".cusCodeFile span").hide();HdPortal.hdShowMsg("right","上传成功",true);if(tip.hasClass("errMsg")){tip.text("每个券号不超过20个字符，券号数量与奖品数量需一致，发布后生成券号方式将无法更改");tip.addClass("tipsColor").removeClass("errMsg")}ERR.removeErr($("#awardsSetting .cusCodeFile").eq(index));checkCuscode(index)})})}else{var times=0;var allTimes=50;var checkUploadSuc=setInterval(function(){$.ajax({url:"/ajax/advanceUpload.jsp?cmd=checkUploadSuc&level="+(index+1)+"&id="+game.id+"&total="+amount+"&version="+result.version,success:function(info){info=$.parseJSON(info);if(info.success){HdPortal.wxCardProgress.end(function(){clearInterval(checkUploadSuc);$scope.$safeApply(function(){isChangeCusCode=true;awardList[index].version=info.msg;awardList[index].excelName=result.filename});uploadCusCode.find(".uploadBtn .uploadify-button").text("重新上传");uploadCusCode.find(".cusCodeFile span").hide();HdPortal.hdShowMsg("right","上传成功",true);tip.removeClass("errMsg").addClass("tipsColor").html('每个券号不超过<span class="codeLimitLen">40</span>个字符，券号数量与奖品数量需一致，发布后生成券号方式将无法更改');ERR.removeErr(tip)})}else{if(times==allTimes){HdPortal.wxCardProgress.end(function(){HdPortal.hdShowMsg("error","上传失败",true)})}}}})},2000,allTimes)}}else{HdPortal.wxCardProgress.end(function(){HdPortal.hdShowMsg("error","上传失败",true);if(result.tip){tip.text(result.msg)}if(!tip.hasClass("errMsg")){tip.removeClass("tipsColor").addClass("errMsg")}ERR.addErr($("#awardsSetting .cusCodeFile").eq(index))})}}function getCodeListByVal(val){if(typeof val!="string"||val.length==0){return[]}var arr=val.split("\n").map(function(item,index){return item.trim()});arr=arr.filter(function(item,index){if(item!=""){return true}else{return false}});return arr}})(app);